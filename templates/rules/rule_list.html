{% extends 'base/base.html' %}
{% load core_tags %}

{% block title %}Classification Rules - {{ subject.name }} - PYQ Analyzer{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="sm:flex sm:items-center sm:justify-between mb-8">
        <div>
            <nav class="flex mb-2" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{% url 'subjects:detail' subject.id %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400">
                            {{ subject.code }}
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                            <span class="ml-1 text-sm font-medium text-gray-700 dark:text-gray-300">Rules</span>
                        </div>
                    </li>
                </ol>
            </nav>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Classification Rules</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Define rules in plain English to automatically classify questions
            </p>
        </div>
        <div class="mt-4 sm:mt-0">
            <a href="{% url 'rules:create' subject.id %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                Add Rule
            </a>
        </div>
    </div>

    <!-- Info Banner -->
    <div class="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 rounded-lg p-4 mb-6">
        <div class="flex">
            <i data-lucide="info" class="w-5 h-5 text-indigo-600 dark:text-indigo-400 flex-shrink-0 mt-0.5"></i>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-indigo-800 dark:text-indigo-200">How Rules Work</h3>
                <p class="mt-1 text-sm text-indigo-700 dark:text-indigo-300">
                    Write rules in plain English like "Questions 1-5 belong to Module 1" or "Questions containing 'Fourier transform' belong to Module 3".
                    Our AI will convert these to executable classification logic.
                </p>
            </div>
        </div>
    </div>

    <!-- Rules List -->
    {% if rules %}
    <div class="space-y-4">
        {% for rule in rules %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6" id="rule-{{ rule.id }}">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-4">
                    <div class="flex items-center justify-center h-10 w-10 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 font-semibold">
                        {{ rule.priority }}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">{{ rule.name }}</h3>
                            {% if rule.is_enabled %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                                Active
                            </span>
                            {% else %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                Disabled
                            </span>
                            {% endif %}
                        </div>
                        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">{{ rule.rule_text }}</p>
                        
                        <!-- Parsed Rule Details -->
                        {% if rule.parsed_rule.conditions %}
                        <div class="mt-3 flex flex-wrap gap-2">
                            {% if rule.parsed_rule.conditions.question_numbers %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300">
                                <i data-lucide="hash" class="w-3 h-3 mr-1"></i>
                                Q: {{ rule.parsed_rule.conditions.question_numbers|join:", " }}
                            </span>
                            {% endif %}
                            {% if rule.parsed_rule.conditions.question_ranges %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300">
                                <i data-lucide="arrow-right" class="w-3 h-3 mr-1"></i>
                                Range: {% for r in rule.parsed_rule.conditions.question_ranges %}{{ r.0 }}-{{ r.1 }}{% if not forloop.last %}, {% endif %}{% endfor %}
                            </span>
                            {% endif %}
                            {% if rule.parsed_rule.conditions.keywords %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-50 text-purple-700 dark:bg-purple-900/20 dark:text-purple-300">
                                <i data-lucide="tag" class="w-3 h-3 mr-1"></i>
                                Keywords: {{ rule.parsed_rule.conditions.keywords|slice:":3"|join:", " }}{% if rule.parsed_rule.conditions.keywords|length > 3 %}...{% endif %}
                            </span>
                            {% endif %}
                            {% if rule.parsed_rule.action.module %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-indigo-50 text-indigo-700 dark:bg-indigo-900/20 dark:text-indigo-300">
                                <i data-lucide="folder" class="w-3 h-3 mr-1"></i>
                                â†’ Module {{ rule.parsed_rule.action.module }}
                            </span>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Stats -->
                        <div class="mt-3 flex items-center text-xs text-gray-500 dark:text-gray-400 space-x-4">
                            <span>
                                <i data-lucide="check-circle" class="w-3 h-3 inline mr-1"></i>
                                {{ rule.match_count }} matches
                            </span>
                            {% if rule.last_matched_at %}
                            <span>Last matched {{ rule.last_matched_at|timesince }} ago</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center space-x-2">
                    <button type="button"
                            hx-post="{% url 'rules:toggle' rule.id %}"
                            hx-swap="outerHTML"
                            hx-target="#rule-{{ rule.id }}"
                            class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" 
                            title="{% if rule.is_enabled %}Disable{% else %}Enable{% endif %}">
                        <i data-lucide="{% if rule.is_enabled %}toggle-right{% else %}toggle-left{% endif %}" class="w-5 h-5"></i>
                    </button>
                    <a href="{% url 'rules:edit' rule.id %}" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Edit">
                        <i data-lucide="edit" class="w-5 h-5"></i>
                    </a>
                    <button type="button"
                            hx-delete="{% url 'rules:delete' rule.id %}"
                            hx-confirm="Are you sure you want to delete this rule?"
                            hx-target="#rule-{{ rule.id }}"
                            hx-swap="outerHTML"
                            class="p-2 text-gray-400 hover:text-red-600 dark:hover:text-red-400" title="Delete">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Re-apply Rules Button -->
    <div class="mt-6 flex justify-center">
        <button type="button"
                hx-post="{% url 'rules:apply_all' subject.id %}"
                hx-target="#apply-result"
                hx-swap="innerHTML"
                class="inline-flex items-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
            <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
            Re-apply All Rules to Questions
        </button>
    </div>
    <div id="apply-result" class="mt-4"></div>
    
    {% else %}
    {% include 'components/empty_state.html' with icon="git-branch" title="No rules defined" description="Create your first classification rule to automatically categorize questions into modules." action_url=create_url action_text="Create First Rule" action_icon="plus" %}
    {% endif %}
</div>
{% endblock %}
