{% extends 'base/base.html' %}

{% block title %}Upload Papers - PYQ Analyzer{% endblock %}

{% block extra_head %}
<style>
.upload-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.upload-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

.drag-active {
    transform: scale(1.02);
    border-color: #6366f1 !important;
    background: rgba(99, 102, 241, 0.05);
}

@keyframes file-add {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

.file-item {
    animation: file-add 0.3s ease-out;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Enhanced Header -->
        <div class="mb-12 text-center scroll-reveal">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
                Upload Question Papers
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
                Upload your PDF question papers. Our AI will automatically extract and classify questions with intelligent analysis.
            </p>
        </div>

        <!-- Upload Form -->
        <form method="post" enctype="multipart/form-data" class="space-y-8" x-data="batchUpload()">
            {% csrf_token %}
            
            <!-- University Selection -->
            <div class="upload-card bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-8 scroll-reveal">
                <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center mr-3">
                        <i data-lucide="building" class="w-6 h-6 text-white"></i>
                    </div>
                    Select University Type
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <label class="relative group flex items-center p-6 border-2 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105"
                           :class="university === 'KTU' ? 'border-indigo-500 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 shadow-lg' : 'border-gray-200 dark:border-gray-600 hover:border-indigo-300 hover:shadow-md'">
                        <input type="radio" name="university" value="KTU" x-model="university" class="sr-only">
                        <div class="flex items-center flex-1">
                            <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-indigo-600 dark:bg-indigo-900 rounded-xl flex items-center justify-center mr-4 shadow-md">
                                <span class="text-white dark:text-indigo-200 font-bold text-lg">KTU</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white text-lg">Kerala Technical University</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">2019 Scheme - Auto module classification</p>
                            </div>
                        </div>
                        <i data-lucide="check-circle" class="w-7 h-7 text-indigo-600 dark:text-indigo-400" x-show="university === 'KTU'"></i>
                    </label>
                    
                    <label class="relative group flex items-center p-6 border-2 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105"
                           :class="university === 'OTHER' ? 'border-purple-500 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 shadow-lg' : 'border-gray-200 dark:border-gray-600 hover:border-purple-300 hover:shadow-md'">
                        <input type="radio" name="university" value="OTHER" x-model="university" class="sr-only">
                        <div class="flex items-center flex-1">
                            <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 dark:bg-gray-700 rounded-xl flex items-center justify-center mr-4 shadow-md">
                                <i data-lucide="graduation-cap" class="w-7 h-7 text-white dark:text-gray-200"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white text-lg">Other University</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">AI-powered module classification</p>
                            </div>
                        </div>
                        <i data-lucide="check-circle" class="w-7 h-7 text-purple-600 dark:text-purple-400" x-show="university === 'OTHER'"></i>
                    </label>
                </div>
                
                <!-- Subject Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Subject Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="subject_name" x-model="subjectName" required
                               class="form-input w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white transition-all duration-300"
                               placeholder="e.g., Disaster Management">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Subject Code <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="subject_code" x-model="subjectCode" required
                               class="form-input w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white transition-all duration-300"
                               placeholder="e.g., MCN301">
                    </div>
                </div>
            </div>
            
            <!-- KTU Rules Info -->
            <div class="upload-card p-6 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 border-2 border-indigo-200 dark:border-indigo-700 rounded-2xl scroll-reveal" 
                 x-show="university === 'KTU'" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-cloak>
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-12 h-12 bg-indigo-500 rounded-xl flex items-center justify-center mr-4">
                        <i data-lucide="info" class="w-6 h-6 text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-indigo-900 dark:text-indigo-300 mb-3 text-lg">KTU 2019 Scheme - Question to Module Mapping:</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-indigo-800 dark:text-indigo-200">
                            <div class="bg-white/50 dark:bg-gray-800/50 p-3 rounded-lg">
                                <strong class="block mb-1">Part A:</strong>
                                Q1-2 → Module 1<br>
                                Q3-4 → Module 2<br>
                                Q5-6 → Module 3<br>
                                Q7-8 → Module 4<br>
                                Q9-10 → Module 5
                            </div>
                            <div class="bg-white/50 dark:bg-gray-800/50 p-3 rounded-lg">
                                <strong class="block mb-1">Part B:</strong>
                                Q11-12 → Module 1<br>
                                Q13-14 → Module 2<br>
                                Q15-16 → Module 3<br>
                                Q17-18 → Module 4<br>
                                Q19-20 → Module 5
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- File Upload Area -->
            <div class="upload-card bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-8 scroll-reveal">
                <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6 flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center mr-3">
                        <i data-lucide="files" class="w-6 h-6 text-white"></i>
                    </div>
                    Select PDF Files
                </h2>
                
                <div 
                    class="mt-1 flex justify-center px-6 pt-12 pb-12 border-3 border-dashed rounded-2xl transition-all duration-300 cursor-pointer group"
                    :class="dragover ? 'drag-active border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20 scale-105' : 'border-gray-300 dark:border-gray-600 hover:border-indigo-400 hover:bg-gray-50 dark:hover:bg-gray-700/30'"
                    @dragover.prevent="dragover = true"
                    @dragleave.prevent="dragover = false"
                    @drop.prevent="handleDrop($event)"
                    @click="$refs.fileInput.click()"
                >
                    <div class="space-y-4 text-center">
                        <div class="mx-auto h-24 w-24 bg-gradient-to-br from-indigo-100 to-purple-100 dark:from-indigo-900/40 dark:to-purple-900/40 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="upload-cloud" class="h-12 w-12 text-indigo-600 dark:text-indigo-400"></i>
                        </div>
                        <div class="text-base text-gray-600 dark:text-gray-400">
                            <span class="font-semibold text-indigo-600 dark:text-indigo-400 text-lg">Click to select files</span>
                            <span class="block mt-1">or drag and drop</span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-500">
                            PDF files only • Up to 50MB each • Select multiple files
                        </p>
                    </div>
                </div>
                
                <input 
                    type="file" 
                    name="files" 
                    accept=".pdf" 
                    multiple
                    class="hidden" 
                    x-ref="fileInput" 
                    @change="handleFileSelect($event)"
                >
                
                {% if form.files.errors %}
                <div class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl">
                    <ul class="text-sm text-red-600 dark:text-red-400 list-disc list-inside space-y-1">
                        {% for error in form.files.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            
            <!-- Selected Files Preview -->
            <div x-show="files.length > 0" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-cloak 
                 class="upload-card bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-8 scroll-reveal">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-3">
                            <i data-lucide="check-circle" class="w-6 h-6 text-white"></i>
                        </div>
                        Selected Files
                        <span class="ml-3 text-lg font-normal text-gray-500" x-text="'(' + files.length + ' ' + (files.length === 1 ? 'file' : 'files') + ')'"></span>
                    </h2>
                    <button type="button" @click="clearAll()" class="text-sm font-semibold text-red-600 hover:text-red-700 dark:text-red-400 px-4 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors duration-200">
                        Clear All
                    </button>
                </div>
                
                <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                    <template x-for="(file, index) in files" :key="index">
                        <div class="file-item flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700/50 dark:to-gray-600/50 rounded-xl hover:shadow-md transition-all duration-300 group">
                            <div class="flex items-center min-w-0 flex-1">
                                <div class="flex-shrink-0 h-14 w-14 bg-gradient-to-br from-red-500 to-pink-500 rounded-xl flex items-center justify-center shadow-md">
                                    <i data-lucide="file-text" class="w-7 h-7 text-white"></i>
                                </div>
                                <div class="ml-4 min-w-0 flex-1">
                                    <p class="text-base font-semibold text-gray-900 dark:text-white truncate" x-text="file.name"></p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400" x-text="formatSize(file.size)"></p>
                                </div>
                            </div>
                            <button type="button" @click="removeFile(index)" class="ml-4 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg flex-shrink-0 transition-all duration-200 group-hover:scale-110">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </template>
                </div>
                
                <div class="mt-6 pt-6 border-t-2 border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <div class="text-base text-gray-600 dark:text-gray-400">
                        <span class="font-semibold">Total Size:</span> 
                        <span class="text-indigo-600 dark:text-indigo-400 font-bold" x-text="formatSize(totalSize())"></span>
                    </div>
                    <button type="button" @click="$refs.fileInput.click()" class="inline-flex items-center text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 font-semibold px-4 py-2 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-all duration-200">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Add More Files
                    </button>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center mt-10">
                <button 
                    type="submit" 
                    class="group inline-flex items-center px-12 py-4 border border-transparent rounded-2xl shadow-xl text-lg font-bold text-white bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 hover:from-indigo-700 hover:via-purple-700 hover:to-pink-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-105 active:scale-95"
                    :disabled="files.length === 0"
                    :class="files.length === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-2xl'"
                >
                    <i data-lucide="rocket" class="w-6 h-6 mr-3 group-hover:animate-bounce"></i>
                    <span x-text="files.length > 0 ? 'Upload ' + files.length + ' Paper' + (files.length > 1 ? 's' : '') : 'Upload Papers'"></span>
                    <svg class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                    </svg>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function batchUpload() {
    return {
        dragover: false,
        files: [],
        university: 'KTU',
        subjectName: '',
        subjectCode: '',
        
        handleDrop(e) {
            this.dragover = false;
            const droppedFiles = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf'));
            this.addFiles(droppedFiles);
        },
        
        handleFileSelect(e) {
            const selectedFiles = Array.from(e.target.files);
            this.addFiles(selectedFiles);
        },
        
        addFiles(newFiles) {
            newFiles.forEach(file => {
                const exists = this.files.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    this.files.push(file);
                }
            });
            this.updateInput();
            
            // Auto-detect subject from filename
            if (newFiles.length > 0 && !this.subjectName) {
                const filename = newFiles[0].name;
                const match = filename.match(/([A-Z]{2,3}\d{3})\s*(.+?)(?:,|\s+(?:NOVEMBER|DECEMBER|MAY|JUNE|APRIL))/i);
                if (match) {
                    this.subjectCode = match[1].toUpperCase();
                    this.subjectName = match[2].trim();
                }
            }
        },
        
        removeFile(index) {
            this.files.splice(index, 1);
            this.updateInput();
        },
        
        clearAll() {
            this.files = [];
            this.updateInput();
        },
        
        updateInput() {
            const dt = new DataTransfer();
            this.files.forEach(file => dt.items.add(file));
            this.$refs.fileInput.files = dt.files;
        },
        
        totalSize() {
            return this.files.reduce((sum, f) => sum + f.size, 0);
        },
        
        formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    }
}
</script>
{% endblock %}
